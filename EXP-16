#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <math.h>

#define MAX 1000
#define CANDIDATES 26

/* English letter frequencies (%) */
double engFreq[26] = {
    8.167,1.492,2.782,4.253,12.702,2.228,2.015,
    6.094,6.966,0.153,0.772,4.025,2.406,6.749,
    7.507,1.929,0.095,5.987,6.327,9.056,
    2.758,0.978,2.360,0.150,1.974,0.074
};

char englishOrder[] = "ETAOINSHRDLCUMWFGYPBVKJXQZ";

typedef struct {
    char text[MAX];
    double score;
} Result;

/* Count letter frequencies */
void countFreq(char *text, int freq[])
{
    memset(freq, 0, 26 * sizeof(int));
    for(int i = 0; text[i]; i++)
        if(isalpha(text[i]))
            freq[toupper(text[i]) - 'A']++;
}

/* Generate substitution mapping */
void buildKey(int cipherFreq[], int shift, char key[])
{
    int used[26] = {0};
    int idx[26];

    for(int i = 0; i < 26; i++)
        idx[i] = i;

    /* Sort ciphertext letters by frequency */
    for(int i = 0; i < 25; i++)
        for(int j = i + 1; j < 26; j++)
            if(cipherFreq[idx[j]] > cipherFreq[idx[i]])
            {
                int t = idx[i];
                idx[i] = idx[j];
                idx[j] = t;
            }

    /* Map cipher letters â†’ English letters with rotation */
    for(int i = 0; i < 26; i++)
    {
        int p = (i + shift) % 26;
        key[idx[i]] = englishOrder[p];
        used[p] = 1;
    }
}

/* Apply substitution */
void decrypt(char *cipher, char *plain, char key[])
{
    int i;
    for(i = 0; cipher[i]; i++)
    {
        if(isalpha(cipher[i]))
            plain[i] = key[toupper(cipher[i]) - 'A'];
        else
            plain[i] = cipher[i];
    }
    plain[i] = '\0';
}

/* Chi-square English score */
double scoreText(char *text)
{
    int count[26] = {0}, total = 0;
    double score = 0;

    for(int i = 0; text[i]; i++)
        if(isalpha(text[i]))
        {
            count[text[i] - 'A']++;
            total++;
        }

    for(int i = 0; i < 26; i++)
    {
        double expected = engFreq[i] * total / 100;
        if(expected > 0)
            score += pow(count[i] - expected, 2) / expected;
    }

    return score;
}

/* Sort results */
void sortResults(Result r[], int n)
{
    for(int i = 0; i < n - 1; i++)
        for(int j = i + 1; j < n; j++)
            if(r[j].score < r[i].score)
            {
                Result t = r[i];
                r[i] = r[j];
                r[j] = t;
            }
}

int main()
{
    char cipher[MAX];
    int freq[26];
    Result results[CANDIDATES];
    int topN;

    printf("Enter Ciphertext:\n");
    gets(cipher);

    printf("How many top plaintexts to display? ");
    scanf("%d", &topN);

    countFreq(cipher, freq);

    for(int i = 0; i < CANDIDATES; i++)
    {
        char key[26];
        buildKey(freq, i, key);
        decrypt(cipher, results[i].text, key);
        results[i].score = scoreText(results[i].text);
    }

    sortResults(results, CANDIDATES);

    printf("\nTop %d Possible Plaintexts:\n", topN);
    for(int i = 0; i < topN && i < CANDIDATES; i++)
    {
        printf("\nRank %d | Score %.2f\n%s\n",
               i + 1, results[i].score, results[i].text);
    }

    return 0;
}
