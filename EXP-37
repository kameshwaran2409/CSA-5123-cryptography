#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <time.h>

#define MAX_RESULTS 20
#define TEXT_LEN 2000

/* English letter frequencies (%) */
double english_freq[26] = {
    8.167, 1.492, 2.782, 4.253, 12.702, 2.228, 2.015,
    6.094, 6.966, 0.153, 0.772, 4.025, 2.406,
    6.749, 7.507, 1.929, 0.095, 5.987, 6.327,
    9.056, 2.758, 0.978, 2.360, 0.150, 1.974, 0.074
};

typedef struct {
    char text[TEXT_LEN];
    double score;
} Result;

/* Generate random monoalphabetic key */
void random_key(char key[26]) {
    for (int i = 0; i < 26; i++) key[i] = 'A' + i;
    for (int i = 25; i > 0; i--) {
        int j = rand() % (i + 1);
        char t = key[i]; key[i] = key[j]; key[j] = t;
    }
}

/* Decrypt using key */
void decrypt(char *cipher, char *plain, char key[26]) {
    for (int i = 0; cipher[i]; i++) {
        if (isalpha(cipher[i])) {
            plain[i] = key[toupper(cipher[i]) - 'A'];
        } else plain[i] = cipher[i];
    }
}

/* Compute chi-squared score */
double score_text(char *text) {
    int count[26] = {0}, total = 0;
    for (int i = 0; text[i]; i++) {
        if (isalpha(text[i])) {
            count[toupper(text[i]) - 'A']++;
            total++;
        }
    }
    if (total == 0) return 1e9;

    double chi = 0.0;
    for (int i = 0; i < 26; i++) {
        double expected = english_freq[i] * total / 100.0;
        double diff = count[i] - expected;
        chi += (diff * diff) / expected;
    }
    return chi;
}

/* Insert result into sorted list */
void insert(Result results[], int *n, char *text, double score, int max) {
    if (*n < max || score < results[*n - 1].score) {
        if (*n < max) (*n)++;
        int i = *n - 1;
        while (i > 0 && results[i - 1].score > score) {
            results[i] = results[i - 1];
            i--;
        }
        strcpy(results[i].text, text);
        results[i].score = score;
    }
}

int main() {
    char cipher[TEXT_LEN];
    printf("Enter ciphertext:\n");
    fgets(cipher, sizeof(cipher), stdin);

    int topN;
    printf("How many top plaintexts to display? ");
    scanf("%d", &topN);
    if (topN > MAX_RESULTS) topN = MAX_RESULTS;

    srand(time(NULL));
    Result results[MAX_RESULTS];
    int count = 0;

    for (int i = 0; i < 5000; i++) {
        char key[26], plain[TEXT_LEN];
        random_key(key);
        decrypt(cipher, plain, key);
        double s = score_text(plain);
        insert(results, &count, plain, s, topN);
    }

    printf("\nTop %d candidate plaintexts:\n\n", topN);
    for (int i = 0; i < count; i++) {
        printf("Rank %d (score %.2f):\n%s\n\n",
               i + 1, results[i].score, results[i].text);
    }

    return 0;
}
