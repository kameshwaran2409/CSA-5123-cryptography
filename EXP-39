#include <stdio.h>
#include <string.h>
#include <ctype.h>

#define MAX 1000

/* English letter frequencies (%) */
double eng_freq[26] = {
    8.167,1.492,2.782,4.253,12.702,2.228,2.015,
    6.094,6.966,0.153,0.772,4.025,2.406,
    6.749,7.507,1.929,0.095,5.987,6.327,
    9.056,2.758,0.978,2.360,0.150,1.974,0.074
};

typedef struct {
    int key;
    double score;
    char text[MAX];
} Result;

/* Decrypt with additive cipher */
void decrypt(char *cipher, char *plain, int key) {
    for (int i = 0; cipher[i]; i++) {
        if (isalpha(cipher[i])) {
            char base = isupper(cipher[i]) ? 'A' : 'a';
            plain[i] = (cipher[i] - base - key + 26) % 26 + base;
        } else {
            plain[i] = cipher[i];
        }
    }
    plain[strlen(cipher)] = '\0';
}

/* Chi-squared scoring */
double score_text(char *text) {
    int count[26] = {0}, total = 0;

    for (int i = 0; text[i]; i++) {
        if (isalpha(text[i])) {
            count[toupper(text[i]) - 'A']++;
            total++;
        }
    }

    if (total == 0) return 1e9;

    double chi = 0.0;
    for (int i = 0; i < 26; i++) {
        double expected = eng_freq[i] * total / 100.0;
        double diff = count[i] - expected;
        chi += (diff * diff) / expected;
    }
    return chi;
}

/* Sort results by score */
void sort(Result r[], int n) {
    for (int i = 0; i < n-1; i++)
        for (int j = i+1; j < n; j++)
            if (r[j].score < r[i].score) {
                Result t = r[i];
                r[i] = r[j];
                r[j] = t;
            }
}

int main() {
    char cipher[MAX];
    Result results[26];

    printf("Enter ciphertext:\n");
    fgets(cipher, MAX, stdin);

    int topN;
    printf("How many top plaintexts to show? ");
    scanf("%d", &topN);
    if (topN > 26) topN = 26;

    for (int k = 0; k < 26; k++) {
        results[k].key = k;
        decrypt(cipher, results[k].text, k);
        results[k].score = score_text(results[k].text);
    }

    sort(results, 26);

    printf("\nTop %d possible plaintexts:\n\n", topN);
    for (int i = 0; i < topN; i++) {
        printf("Rank %d | Key = %d | Score = %.2f\n",
               i + 1, results[i].key, results[i].score);
        printf("%s\n\n", results[i].text);
    }

    return 0;
}
