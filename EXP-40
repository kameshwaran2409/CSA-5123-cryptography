#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

#define MAX_TEXT 1000
#define MAX_RESULTS 10

/* English letter frequency (%) */
double eng_freq[26] = {
    8.17,1.49,2.78,4.25,12.70,2.23,2.02,
    6.09,6.97,0.15,0.77,4.03,2.41,
    6.75,7.51,1.93,0.10,5.99,6.33,
    9.06,2.76,0.98,2.36,0.15,1.97,0.07
};

typedef struct {
    char text[MAX_TEXT];
    double score;
} Result;

/* Compute chi-squared score */
double score_text(char *text) {
    int count[26] = {0}, total = 0;

    for (int i = 0; text[i]; i++) {
        if (isalpha(text[i])) {
            count[toupper(text[i]) - 'A']++;
            total++;
        }
    }

    if (total == 0) return 1e9;

    double chi = 0.0;
    for (int i = 0; i < 26; i++) {
        double expected = eng_freq[i] * total / 100.0;
        double diff = count[i] - expected;
        chi += (diff * diff) / expected;
    }
    return chi;
}

/* Generate frequency-based substitution key */
void build_key(int freq[26], char key[26]) {
    int used[26] = {0};
    for (int i = 0; i < 26; i++) {
        int max = -1, idx = -1;
        for (int j = 0; j < 26; j++) {
            if (!used[j] && freq[j] > max) {
                max = freq[j];
                idx = j;
            }
        }
        used[idx] = 1;
        key[idx] = "ETAOINSHRDLCUMWFGYPBVKJXQZ"[i];
    }
}

/* Decrypt using substitution key */
void decrypt(char *cipher, char *plain, char key[26]) {
    for (int i = 0; cipher[i]; i++) {
        if (isalpha(cipher[i]))
            plain[i] = key[toupper(cipher[i]) - 'A'];
        else
            plain[i] = cipher[i];
    }
    plain[strlen(cipher)] = '\0';
}

int main() {
    char cipher[MAX_TEXT];
    Result results[MAX_RESULTS];
    int result_count = 0;

    printf("Enter ciphertext:\n");
    fgets(cipher, MAX_TEXT, stdin);

    int topN;
    printf("Enter number of top plaintexts: ");
    scanf("%d", &topN);
    if (topN > MAX_RESULTS) topN = MAX_RESULTS;

    int freq[26] = {0};
    for (int i = 0; cipher[i]; i++)
        if (isalpha(cipher[i]))
            freq[toupper(cipher[i]) - 'A']++;

    for (int k = 0; k < topN; k++) {
        char key[26], plain[MAX_TEXT];

        build_key(freq, key);
        decrypt(cipher, plain, key);

        results[k].score = score_text(plain);
        strcpy(results[k].text, plain);
    }

    printf("\nTop %d Possible Plaintexts:\n\n", topN);
    for (int i = 0; i < topN; i++) {
        printf("Rank %d (Score %.2f):\n%s\n\n",
               i + 1, results[i].score, results[i].text);
    }

    return 0;
}
